# scRNA-seq data filtering, processing, clustering, cell type annotation
Process from counts matrices to a merged and annotated Seurat-object for all primary tumor and control tissue samples. Detailed steps for processing and annotation are explained below and the workflow is shown [here](./GE_analysis_primary_tumors.ipynb). Processing and cell type annotation for the full dataset consisting of cells from primary tumor, control tissue, early allograft samples and late allograft tumors is shown [here](./GE_analysis_all_timepoints.ipynb).  
Counts matrices were generated by mapping with cellranger count. Analyses described and shown here were carried out in [this environment](r4.yml) with indicated package versions.  

## Steps
Workflow for primary tumor and control tissue data merging, processing and annotation.
  
**1. Filtering**  
For MULTI-seq datasets, cell barcodes were assigned to their sample of origin based on MULTI-seq sample barcode reads. Cells not assigned to a sample or labelled as inter-sample doublets were removed. This process is not shown here. Cell barcodes with sample assignment are directly loaded into Seurat and valid cells are further filtered to have information on at least 200 genes.  
For a sample processed on an individual 10x run, the distribution of number of genes and UMIs per cell is plotted and low-quality cells and putative doublets are removed based on this. Again, cells must also have information on at least 200 genes.  
  
**2. Merging**  
Raw counts for valid cells from all datasets are merged and thereafter processed together.  
  
**3. Processing** 
Processing of the merged object follows the standard Seurat workflow with log-normalization and scaling of all genes. Variable features are then identified. To reduce inter-sample batch effects and enhance cell type separation in clustering, the following gene sets are excluded from the variable features list:
- genes that are significantly more highly expressed across all cells (of all cell types) in a dataset compared to all other dataset
- the human transgenes, different sets of which are present in different fish
- known [cell cycle markers](./zfish_prolif_markers.csv) to reduce co-clustering of cycling cells from different cell types  
  
The variable genes list is then used for PCA of the cells, followed by Louvain clustering and UMAP-visualization.  
  
**4. Cell type annotation**  
In the first instance, clusters are assigned cell types based on:
- expression of published cell type marker gene sets. These are available [here](./celltype_assign_files/celltype_markers_tang_hu_clean.csv) and are taken from [Tang et al. 2017](https://doi.org/10.1084/jem.20170976), [Hu et al. 2022](https://doi.org/10.1038/s41588-022-01129-5) and [Van Groningen et al. 2017](https://doi.org/10.1038/ng.3899).
- cluster marker genes determined by differential expression analysis of cells in a cluster compared to all other cluster. Cluster marker gene lists for this step and all following are in the respective files in [directory 'celltype_assign_files'](./celltype_assign_files/).
  
The first round of cell type annotations serves to split the data into subgroups of cell types for sub-clustering and repeated higher resolution cell type assignment. This is done in the following steps with marker gene lists for clusters in all sub-datasets and respective cluster-cell type-assignments provided in [directory 'celltype_assign_files'](./celltype_assign_files/).
- NB cell sub-clustering
- TME cell sub-clustering
- TME cells are further subset for stromal cell sub-clustering
- TME cells are further subset for immune / blood cell sub-clustering
  
Finally, high resolution cell type annotation from the sub-clustered data is transferred back to the full data object.  
Cell type marker genes are determined via differential expression analysis and are provided [here](./celltype_assign_files/clusterMarkersAll_allmerged_final_CelltypeOverall_minpct40_logfct_70.csv).

